name: TRAVELMATE-CICD

on:
  push:
    branches: ['master']
  pull_request:
    branches: ['master']

# Env
env:
  DOCKER_IMAGE: ghcr.io/travel-mate/travelmate-server
  DOCKER_CONTAINER: nest-server

jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Nodejs 18
        uses: actions/setup-node@v3
        with:
          node-version: 18.15.0
          cache: 'npm'

      - name: Setting .env
        run: |
          # echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
          # echo "DATABASE_DB=${{ secrets.DATABASE_DB }}" >> .env
          # echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          # echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          # echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          # echo "DATABASE_USER=${{ secrets.DATABASE_USER }}" >> .env
          # echo "SWAGGER_ID=${{ secrets.SWAGGER_ID }}" >> .env
          # echo "SWAGGER_PW=${{ secrets.SWAGGER_PW }}" >> .env
          cat .env

      - run: npm install
      - run: npm run test

  # Config : Build & Push to GHCR Docker Image
  build:
    needs: test
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        user: ['YuuuJeong']
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Set up Docker build
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to ghcr
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ matrix.user }}
          password: ${{ secrets.ACCESS_TOKEN }}

      - name: Build and Push
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

  # # Config : Deploy To Cloud Server
  # deploy:
  #   needs: build
  #   runs-on: [self-hosted, blk]
  #   steps:
  #     - name: Login to ghcr
  #       uses: docker/login-action@v2
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.ACCESS_TOKEN }}
  #     # Docker Start! (Del Current Container & Image)
  #     - name: Running Docker
  #       run: |
  #         echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
  #         cat .env
  #         docker stop ${{ env.DOCKER_CONTAINER }} && docker rm ${{ env.DOCKER_CONTAINER }} && docker rmi ${{ env.DOCKER_IMAGE }}:latest
  #         docker run --env-file ./.env -d -p 80:8080 --name ${{ env.DOCKER_CONTAINER }} --restart always ${{ env.DOCKER_IMAGE }}:latest
